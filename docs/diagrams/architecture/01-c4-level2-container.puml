@startuml C4_Level2_컨테이너_다이어그램
' ============================================================
' 템플릿: C4 Model Level 2 - Container Diagram
' 사용 사례:
'   - 기술 스택 선택 (Frontend, Backend, Database)
'   - 컨테이너 간 통신 프로토콜
'   - 배포 단위 식별
' ============================================================

!theme plain
skinparam backgroundColor white

title C4 Model - Level 2: Container Diagram

' ───────────────────────────────────────────────────────────
' 스타일 정의
' ───────────────────────────────────────────────────────────
skinparam rectangle {
  BackgroundColor<<person>> #F0F0F0
  BackgroundColor<<webapp>> #E8E8E8
  BackgroundColor<<spa>> #E0E0E0
  BackgroundColor<<mobile>> #D8D8D8
  BackgroundColor<<api>> #D0D0D0
  BackgroundColor<<database>> #C8C8C8
  BackgroundColor<<cache>> #C0C0C0
  BackgroundColor<<queue>> #B8B8B8
  BorderColor Black
}

skinparam database {
  BackgroundColor #C8C8C8
  BorderColor Black
}

skinparam queue {
  BackgroundColor #B8B8B8
  BorderColor Black
}

' ───────────────────────────────────────────────────────────
' 사용자
' ───────────────────────────────────────────────────────────
rectangle "사용자" as user <<person>>

' ───────────────────────────────────────────────────────────
' Frontend Layer
' ───────────────────────────────────────────────────────────
package "Frontend Layer" {
  rectangle "웹 애플리케이션\n\nReact 18, Vite\nPort: 3000" as spa <<spa>>
  rectangle "모바일 앱\n\nReact Native, Expo\niOS, Android" as mobile <<mobile>>
  rectangle "관리자 포털\n\nNext.js 14\nPort: 3001" as admin <<webapp>>
}

' ───────────────────────────────────────────────────────────
' Backend Layer
' ───────────────────────────────────────────────────────────
package "Backend Layer" {
  rectangle "API Gateway\n\nKong/Nginx\nPort: 8080" as gateway <<api>>
  rectangle "User Service\n\nNode.js\nPort: 3100" as userService <<api>>
  rectangle "Project Service\n\nNode.js\nPort: 3200" as projectService <<api>>
  rectangle "Collaboration Service\n\nNode.js + Socket.io\nPort: 3300" as collab <<api>>
  rectangle "Notification Service\n\nNode.js\nPort: 3400" as notification <<api>>
}

' ───────────────────────────────────────────────────────────
' Data Layer
' ───────────────────────────────────────────────────────────
package "Data Layer" {
  database "PostgreSQL\n\nv15, Primary-Replica" as postgres
  database "Redis\n\nCluster (HA)" as redis
  database "MongoDB\n\nDocument DB" as mongo
  queue "Kafka\n\nMessage Queue" as kafka
}

' ───────────────────────────────────────────────────────────
' 관계 정의
' ───────────────────────────────────────────────────────────
user --> spa : HTTPS
user --> mobile : HTTPS
user --> admin : HTTPS

spa --> gateway : REST API
mobile --> gateway : REST API
admin --> gateway : REST API

gateway --> userService : gRPC
gateway --> projectService : gRPC
gateway --> collab : WebSocket
gateway --> notification : REST

userService --> postgres : SQL
projectService --> postgres : SQL
collab --> redis : Pub/Sub
notification --> mongo : Write Logs

userService --> redis : Cache
projectService --> redis : Cache

userService ..> kafka : Publish Events
projectService ..> kafka : Publish Events
notification ..> kafka : Consume Events

' ───────────────────────────────────────────────────────────
' 주석
' ───────────────────────────────────────────────────────────
note right of gateway
  **API Gateway 역할**

  1. 인증/인가
     - JWT 검증
     - API Key 관리

  2. Rate Limiting
     - 사용자별: 100 req/min
     - IP별: 1000 req/min

  3. 로깅 & 모니터링
     - 모든 요청 로그
     - Prometheus Metrics
end note

note bottom of postgres
  **데이터베이스 전략**

  **PostgreSQL (OLTP)**:
  - 트랜잭션 데이터
  - ACID 보장

  **MongoDB (로그)**:
  - 유연한 스키마
  - 고속 Write

  **Redis (캐싱)**:
  - 세션 관리
  - API 응답 캐싱 (TTL: 5분)
end note

note bottom of kafka
  **이벤트 기반 아키텍처**

  **이벤트 예시**:
  - UserRegistered
  - ProjectCreated
  - TaskAssigned

  **Consumer Groups**:
  - notification-group
  - analytics-group
  - audit-log-group

  **보장**:
  - At-least-once delivery
  - Partition 단위 순서 보장
end note

legend right
  **C4 Model Level 2**

  **목적**: 기술 스택 및 통신 프로토콜
  **대상**: 아키텍트, 테크 리드

  **컨테이너**: 독립 실행 가능한 단위
  - 각 서비스는 독립 배포
  - Docker 컨테이너 or Kubernetes Pod

  **다음 레벨**:
  Level 3 → User Service 내부 구조
end legend

@enduml
