@startuml C4_Model_시스템_컨텍스트
' ============================================================
' 템플릿: C4 Model (Context, Container, Component, Code)
' 사용 사례:
'   - 시스템 아키텍처 전체 조감도
'   - Zoom In/Out 방식 계층적 표현
'   - 외부 시스템 연동 관계 시각화
' ============================================================

!theme plain
skinparam backgroundColor white

' ───────────────────────────────────────────────────────────
' C4 Model Level 1: System Context Diagram
' ───────────────────────────────────────────────────────────
title C4 Model - Level 1: System Context

' 스타일 정의
skinparam rectangle {
  BackgroundColor<<person>> #F0F0F0
  BackgroundColor<<system>> #E0E0E0
  BackgroundColor<<external>> #C0C0C0
  BorderColor Black
  FontSize 11
}

' 사용자 (Actors)
rectangle "일반 사용자\n[Person]" as user <<person>> {
}

rectangle "관리자\n[Person]" as admin <<person>> {
}

rectangle "외부 파트너\n[Person]" as partner <<person>> {
}

' 주요 시스템
rectangle "협업 플랫폼\n[Software System]" as mainSystem <<system>> {
  --
  **책임**:
  - 프로젝트 관리
  - 실시간 협업
  - 문서 공유
  - 워크플로우 자동화
  --
  **기술 스택**:
  - React, Node.js, PostgreSQL
}

' 외부 시스템
rectangle "이메일 시스템\n[External System]" as email <<external>> {
  --
  SendGrid / AWS SES
}

rectangle "결제 시스템\n[External System]" as payment <<external>> {
  --
  Stripe / Toss Payments
}

rectangle "파일 스토리지\n[External System]" as storage <<external>> {
  --
  AWS S3 / GCP Cloud Storage
}

rectangle "인증 제공자\n[External System]" as auth <<external>> {
  --
  Auth0 / Keycloak
}

rectangle "분석 시스템\n[External System]" as analytics <<external>> {
  --
  Google Analytics / Mixpanel
}

' 관계 정의
user --> mainSystem : 프로젝트 관리,\n협업, 문서 작성
admin --> mainSystem : 시스템 관리,\n사용자 관리
partner --> mainSystem : API 연동,\n데이터 통합

mainSystem --> email : 알림 이메일 발송\n(SMTP/API)
mainSystem --> payment : 구독 결제 처리\n(REST API)
mainSystem --> storage : 파일 업로드/다운로드\n(S3 API)
mainSystem --> auth : 사용자 인증\n(OAuth 2.0)
mainSystem --> analytics : 사용자 행동 추적\n(JavaScript SDK)

' 주석
note right of mainSystem
  **시스템 경계 (System Boundary)**

  **내부 시스템**: 우리가 개발/관리
  **외부 시스템**: 서드파티 의존성

  **확장 계획**:
  Phase 1: 협업 플랫폼
  Phase 2: Work Management
  Phase 3: ERP 통합
end note

note bottom of email
  **외부 시스템 통합 전략**

  **이메일**:
  - Primary: SendGrid
  - Fallback: AWS SES
  - 장애 시 자동 전환

  **결제**:
  - 국내: Toss Payments
  - 해외: Stripe

  **스토리지**:
  - Multi-Cloud 전략
  - Region별 CDN
end note

@enduml

' ═══════════════════════════════════════════════════════════
' C4 Model Level 2: Container Diagram
' ═══════════════════════════════════════════════════════════
@startuml C4_Model_컨테이너_다이어그램
!theme plain
skinparam backgroundColor white

title C4 Model - Level 2: Container Diagram

skinparam rectangle {
  BackgroundColor<<person>> #F0F0F0
  BackgroundColor<<webapp>> #E8E8E8
  BackgroundColor<<spa>> #E0E0E0
  BackgroundColor<<mobile>> #D8D8D8
  BackgroundColor<<api>> #D0D0D0
  BackgroundColor<<database>> #C8C8C8
  BackgroundColor<<cache>> #C0C0C0
  BackgroundColor<<queue>> #B8B8B8
  BorderColor Black
}

' 사용자
rectangle "사용자" as user <<person>>

' 프론트엔드 컨테이너
package "Frontend Layer" {
  rectangle "웹 애플리케이션\n[React SPA]" as spa <<spa>> {
    --
    **포트**: 3000
    **기술**: React 18, Vite
    **배포**: Vercel / CloudFront
  }

  rectangle "모바일 앱\n[React Native]" as mobile <<mobile>> {
    --
    **플랫폼**: iOS, Android
    **기술**: React Native, Expo
  }

  rectangle "관리자 포털\n[Next.js]" as admin <<webapp>> {
    --
    **포트**: 3001
    **기술**: Next.js 14 (App Router)
    **SSR**: 서버 사이드 렌더링
  }
}

' 백엔드 컨테이너
package "Backend Layer" {
  rectangle "API Gateway\n[Kong/Nginx]" as gateway <<api>> {
    --
    **포트**: 8080
    **책임**: 라우팅, 인증, Rate Limiting
  }

  rectangle "User Service\n[Node.js]" as userService <<api>> {
    --
    **포트**: 3100
    **책임**: 사용자 관리, 인증
  }

  rectangle "Project Service\n[Node.js]" as projectService <<api>> {
    --
    **포트**: 3200
    **책임**: 프로젝트 CRUD, 권한
  }

  rectangle "Collaboration Service\n[Node.js + Socket.io]" as collab <<api>> {
    --
    **포트**: 3300
    **책임**: 실시간 협업, WebSocket
  }

  rectangle "Notification Service\n[Node.js]" as notification <<api>> {
    --
    **포트**: 3400
    **책임**: 이메일, SMS, Push 알림
  }
}

' 데이터 레이어
package "Data Layer" {
  database "PostgreSQL\n[RDBMS]" as postgres <<database>> {
    --
    **버전**: 15
    **용도**: 주요 데이터 저장
    **Replication**: Primary-Replica
  }

  database "Redis\n[Cache]" as redis <<cache>> {
    --
    **용도**: 세션, 캐시, Pub/Sub
    **모드**: Cluster (HA)
  }

  database "MongoDB\n[Document DB]" as mongo <<database>> {
    --
    **용도**: 로그, 이벤트 저장
  }

  queue "Kafka\n[Message Queue]" as kafka <<queue>> {
    --
    **용도**: 이벤트 스트리밍
    **Topics**: user-events, project-events
  }
}

' 관계 정의
user --> spa : HTTPS
user --> mobile : HTTPS
user --> admin : HTTPS

spa --> gateway : REST API
mobile --> gateway : REST API
admin --> gateway : REST API

gateway --> userService : gRPC
gateway --> projectService : gRPC
gateway --> collab : WebSocket
gateway --> notification : REST

userService --> postgres : SQL
projectService --> postgres : SQL
collab --> redis : Pub/Sub
notification --> mongo : Write Logs

userService --> redis : Cache
projectService --> redis : Cache

userService ..> kafka : Publish Events
projectService ..> kafka : Publish Events
notification ..> kafka : Consume Events

' 주석
note right of gateway
  **API Gateway 역할**

  1. **인증/인가**
     - JWT 검증
     - API Key 관리

  2. **Rate Limiting**
     - 사용자별: 100 req/min
     - IP별: 1000 req/min

  3. **로깅 & 모니터링**
     - 모든 요청 로그
     - Prometheus Metrics
end note

note bottom of postgres
  **데이터베이스 전략**

  **PostgreSQL (OLTP)**:
  - 트랜잭션 데이터
  - ACID 보장

  **MongoDB (로그)**:
  - 유연한 스키마
  - 고속 Write

  **Redis (캐싱)**:
  - 세션 관리
  - API 응답 캐싱 (TTL: 5분)
end note

note bottom of kafka
  **이벤트 기반 아키텍처**

  **이벤트 예시**:
  - UserRegistered
  - ProjectCreated
  - TaskAssigned

  **Consumer Groups**:
  - notification-group
  - analytics-group
  - audit-log-group

  **보장**:
  - At-least-once delivery
  - Partition 단위 순서 보장
end note

@enduml

' ═══════════════════════════════════════════════════════════
' C4 Model Level 3: Component Diagram (User Service 예시)
' ═══════════════════════════════════════════════════════════
@startuml C4_Model_컴포넌트_다이어그램
!theme plain
skinparam backgroundColor white

title C4 Model - Level 3: Component Diagram (User Service)

skinparam component {
  BackgroundColor<<controller>> #F0F0F0
  BackgroundColor<<service>> #E0E0E0
  BackgroundColor<<repository>> #D0D0D0
  BackgroundColor<<middleware>> #C8C8C8
  BorderColor Black
}

' API Gateway에서 들어오는 요청
[API Gateway] as gateway

' User Service 컴포넌트들
package "User Service" {
  [Auth Middleware] <<middleware>> as authMiddleware
  [Validation Middleware] <<middleware>> as validationMiddleware

  [User Controller] <<controller>> as userController
  [Auth Controller] <<controller>> as authController

  [User Service] <<service>> as userService
  [Auth Service] <<service>> as authService
  [Email Service] <<service>> as emailService

  [User Repository] <<repository>> as userRepo
  [Session Repository] <<repository>> as sessionRepo
}

' 외부 의존성
database "PostgreSQL" as db
database "Redis" as cache
queue "Kafka" as kafka

' 요청 흐름
gateway --> authMiddleware : HTTP Request
authMiddleware --> validationMiddleware
validationMiddleware --> userController
validationMiddleware --> authController

userController --> userService
authController --> authService

userService --> userRepo
authService --> userRepo
authService --> sessionRepo
userService --> emailService

userRepo --> db
sessionRepo --> cache
userService ..> kafka : Publish Events
emailService ..> kafka : Publish Events

' 주석
note right of authMiddleware
  **Middleware 체인**

  1. Auth Middleware
     - JWT 검증
     - 사용자 정보 추출

  2. Validation Middleware
     - Request Body 검증 (Zod)
     - 타입 체크

  3. Error Middleware
     - 예외 처리
     - 표준화된 에러 응답
end note

note bottom of userService
  **Service Layer (비즈니스 로직)**

  ```typescript
  class UserService {
    async registerUser(dto: RegisterUserDto) {
      // 1. 이메일 중복 검사
      // 2. 비밀번호 해싱
      // 3. User Entity 생성
      // 4. 저장
      // 5. UserRegistered 이벤트 발행
      // 6. 환영 이메일 발송 트리거
    }
  }
  ```

  **원칙**:
  - Controller는 얇게 (Thin)
  - Service에 로직 집중
  - Repository는 데이터 접근만
end note

@enduml
