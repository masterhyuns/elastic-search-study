@startuml 네트워크_보안_아키텍처
' ============================================================
' 템플릿: 네트워크 & 보안 아키텍처
' 사용 사례:
'   - 네트워크 토폴로지 및 보안 경계 표시
'   - 방화벽 규칙, Security Group 설계
'   - Zero Trust 아키텍처 구현
' ============================================================

!theme plain
skinparam backgroundColor white

' ───────────────────────────────────────────────────────────
' 스타일 정의
' ───────────────────────────────────────────────────────────
skinparam rectangle {
  BackgroundColor<<internet>> #F8F8F8
  BackgroundColor<<dmz>> #F0F0F0
  BackgroundColor<<app>> #E0E0E0
  BackgroundColor<<data>> #D0D0D0
  BackgroundColor<<mgmt>> #C0C0C0
  BorderColor Black
  FontSize 10
}

skinparam cloud {
  BackgroundColor #E8E8E8
  BorderColor Black
}

' ───────────────────────────────────────────────────────────
' Internet Layer (외부)
' ───────────────────────────────────────────────────────────
rectangle "Internet" as internet <<internet>> {
  cloud "사용자\n(전 세계)" as users
  cloud "공격자\n(DDoS, Bot)" as attackers
}

' ───────────────────────────────────────────────────────────
' Security Perimeter (경계 보안)
' ───────────────────────────────────────────────────────────
rectangle "AWS Shield\n(DDoS Protection)" as shield {
  --
  **Standard**: 자동 활성화
  **Advanced**: Layer 7 공격 방어
  --
  **방어 대상**:
  - SYN/UDP Flood
  - Reflection Attack
}

rectangle "WAF\n(Web Application Firewall)" as waf {
  --
  **규칙**:
  - SQL Injection 차단
  - XSS 필터링
  - Rate Limiting (IP별)
  - Geo-blocking (특정 국가)
  --
  **Managed Rules**:
  - OWASP Top 10
  - Known Bad Inputs
}

rectangle "CloudFront\n(CDN + Edge Security)" as cdn {
  --
  **보안 기능**:
  - Field-level Encryption
  - Signed URLs/Cookies
  - Origin Shield
  --
  **캐싱**:
  - 정적 컨텐츠: 24시간
  - API 응답: 5분 (선택적)
}

' ───────────────────────────────────────────────────────────
' DMZ Layer (Public Subnet)
' ───────────────────────────────────────────────────────────
rectangle "DMZ Zone\n(Public Subnet)" as dmz <<dmz>> {

  rectangle "ALB\n(Application Load Balancer)" as alb {
    --
    **Security Group**: sg-alb
    **Inbound**:
    - 0.0.0.0/0:443 (HTTPS)
    - 0.0.0.0/0:80 (HTTP → 443 리다이렉트)
    --
    **Outbound**:
    - 10.0.2.0/24:8080 (Backend)
  }

  rectangle "Bastion Host\n(EC2)" as bastion {
    --
    **Security Group**: sg-bastion
    **Inbound**:
    - 사내 IP:22 (SSH)
    - MFA 필수
    --
    **용도**:
    - DB 관리 접근
    - 서버 디버깅
  }

  rectangle "NAT Gateway" as nat {
    --
    **용도**:
    Private Subnet → Internet
    (아웃바운드 전용)
  }
}

' ───────────────────────────────────────────────────────────
' Application Layer (Private Subnet)
' ───────────────────────────────────────────────────────────
rectangle "Application Zone\n(Private Subnet)" as appZone <<app>> {

  rectangle "API Gateway" as apiGW {
    --
    **Security Group**: sg-api-gw
    **Inbound**:
    - sg-alb:8080
    --
    **Outbound**:
    - sg-backend:3000-3999
    - sg-data:6379 (Redis)
  }

  rectangle "Backend Services\n(EKS Pods)" as backend {
    --
    **Security Group**: sg-backend
    **Inbound**:
    - sg-api-gw:3000-3999
    --
    **Outbound**:
    - sg-data:5432 (PostgreSQL)
    - sg-data:6379 (Redis)
    - sg-data:9092 (Kafka)
    - 0.0.0.0/0:443 (외부 API)
  }

  rectangle "Service Mesh\n(Istio)" as serviceMesh {
    --
    **mTLS**:
    - Pod 간 암호화 통신
    - 자동 인증서 갱신
    --
    **Policy**:
    - Zero Trust (기본 거부)
    - Namespace 간 격리
  }
}

' ───────────────────────────────────────────────────────────
' Data Layer (Private Subnet)
' ───────────────────────────────────────────────────────────
rectangle "Data Zone\n(Database Subnet)" as dataZone <<data>> {

  rectangle "RDS PostgreSQL" as rds {
    --
    **Security Group**: sg-rds
    **Inbound**:
    - sg-backend:5432
    - sg-bastion:5432 (관리용)
    --
    **Encryption**:
    - At-rest: AES-256 (KMS)
    - In-transit: SSL/TLS
  }

  rectangle "Redis Cluster" as redis {
    --
    **Security Group**: sg-redis
    **Inbound**:
    - sg-backend:6379
    --
    **Auth**:
    - AUTH token 필수
    - TLS 암호화
  }

  rectangle "Kafka Cluster" as kafka {
    --
    **Security Group**: sg-kafka
    **Inbound**:
    - sg-backend:9092
    --
    **Security**:
    - SASL/SCRAM
    - ACL (Topic별 권한)
  }
}

' ───────────────────────────────────────────────────────────
' Management Layer (격리된 관리 네트워크)
' ───────────────────────────────────────────────────────────
rectangle "Management Zone" as mgmtZone <<mgmt>> {

  rectangle "Monitoring\n(Prometheus + Grafana)" as monitoring {
    --
    **보안**:
    - VPN 접근만 허용
    - OAuth 인증
  }

  rectangle "Logging\n(ELK Stack)" as logging {
    --
    **수집 대상**:
    - ALB Access Logs
    - Application Logs
    - Security Events
  }

  rectangle "Secret Manager\n(AWS Secrets Manager)" as secretMgr {
    --
    **저장 항목**:
    - DB 비밀번호
    - API Keys
    - JWT Secret
    --
    **자동 교체**: 90일마다
  }

  rectangle "Audit Logs\n(CloudTrail)" as cloudTrail {
    --
    **기록**:
    - 모든 API 호출
    - 리소스 변경
    - 로그인 시도
    --
    **보관**: 1년
  }
}

' ───────────────────────────────────────────────────────────
' 네트워크 흐름 & 보안 경계
' ───────────────────────────────────────────────────────────

' Internet → DMZ
users --> shield : HTTPS
attackers -[#red]-> shield : <color:red>공격 차단</color>
shield --> waf : 통과된 트래픽
waf --> cdn : 정상 요청
cdn --> alb : Origin 요청

' DMZ → Application
alb --> apiGW : HTTPS\n(내부 통신)
bastion -[#green,dashed]-> backend : <color:green>SSH (관리)</color>
bastion -[#green,dashed]-> rds : <color:green>psql (관리)</color>

' Application → Data
apiGW --> backend
backend --> serviceMesh : mTLS
serviceMesh --> rds : SQL\n(TLS 암호화)
serviceMesh --> redis : Cache\n(TLS)
serviceMesh --> kafka : Events\n(SASL)

' Private → Internet (via NAT)
backend --> nat : 외부 API\n(SendGrid, Stripe)
nat --> internet

' Management (격리)
backend -[#blue,dotted]-> monitoring : <color:blue>Metrics</color>
backend -[#blue,dotted]-> logging : <color:blue>Logs</color>
backend -[#purple,dotted]-> secretMgr : <color:purple>Secrets 조회</color>
alb -[#blue,dotted]-> cloudTrail : <color:blue>Access Logs</color>

' ───────────────────────────────────────────────────────────
' 주석: Security Group 규칙
' ───────────────────────────────────────────────────────────
note top of alb
  **ALB Security Group (sg-alb)**

  **Inbound Rules**:
  | Source | Protocol | Port | Description |
  | 0.0.0.0/0 | TCP | 443 | HTTPS from Internet |
  | 0.0.0.0/0 | TCP | 80 | HTTP (redirect to 443) |

  **Outbound Rules**:
  | Destination | Protocol | Port | Description |
  | sg-api-gw | TCP | 8080 | To API Gateway |

  **보안 원칙**:
  - 최소 권한 (Least Privilege)
  - Stateful 규칙 (응답 자동 허용)
end note

note right of serviceMesh
  **Service Mesh 보안 정책**

  **mTLS (Mutual TLS)**:
  ```yaml
  apiVersion: security.istio.io/v1beta1
  kind: PeerAuthentication
  metadata:
    name: default
  spec:
    mtls:
      mode: STRICT  # 모든 통신 암호화
  ```

  **Authorization Policy**:
  ```yaml
  apiVersion: security.istio.io/v1beta1
  kind: AuthorizationPolicy
  metadata:
    name: user-service-policy
  spec:
    selector:
      matchLabels:
        app: user-service
    action: ALLOW
    rules:
    - from:
      - source:
          namespaces: ["backend"]
      to:
      - operation:
          methods: ["GET", "POST"]
  ```
end note

note bottom of rds
  **데이터베이스 보안 계층**

  **1. 네트워크 격리**:
  - Private Subnet (인터넷 접근 불가)
  - Security Group (허용 IP만)

  **2. 암호화**:
  - At-rest: KMS (고객 관리 키)
  - In-transit: SSL/TLS 1.2 이상 강제

  **3. 접근 제어**:
  - IAM Database Authentication
  - 최소 권한 DB 사용자

  **4. 감사**:
  - RDS Enhanced Monitoring
  - CloudWatch Logs (Slow Query)
end note

note bottom of secretMgr
  **Secrets 관리 Best Practice**

  **저장 대상**:
  - DB 비밀번호
  - API Keys (외부 서비스)
  - JWT Secret Key
  - 암호화 키

  **자동 교체 (Rotation)**:
  ```python
  def rotate_secret(event, context):
      # 1. 새 비밀번호 생성
      new_password = generate_password()

      # 2. DB에서 비밀번호 변경
      db.change_password(new_password)

      # 3. Secrets Manager 업데이트
      secretsmanager.update_secret(new_password)

      # 4. 애플리케이션 재시작 (Rolling)
  ```

  **주기**: 90일마다 자동
end note

' ───────────────────────────────────────────────────────────
' 보안 사고 대응 절차
' ───────────────────────────────────────────────────────────
note as incidentResponse
  **보안 사고 대응 절차 (Incident Response)**

  **1. 탐지 (Detection)**:
  - CloudWatch Alarms
  - GuardDuty (이상 행동 탐지)
  - WAF 차단 로그 모니터링

  **2. 격리 (Containment)**:
  - 공격 IP Security Group 차단
  - 영향받은 인스턴스 격리
  - 네트워크 ACL 업데이트

  **3. 분석 (Analysis)**:
  - CloudTrail 로그 분석
  - VPC Flow Logs 검토
  - 침해 범위 파악

  **4. 복구 (Recovery)**:
  - 취약점 패치
  - 비밀번호 강제 교체
  - 백업에서 복원

  **5. 개선 (Lessons Learned)**:
  - Post-mortem 작성
  - 보안 정책 업데이트
  - 모의 훈련 실시
end note

' ───────────────────────────────────────────────────────────
' Zero Trust 원칙
' ───────────────────────────────────────────────────────────
note as zeroTrust
  **Zero Trust 아키텍처 원칙**

  **1. 신뢰하지 말고 항상 검증 (Never Trust, Always Verify)**
  - 내부 네트워크도 신뢰 안 함
  - 모든 요청에 인증/인가

  **2. 최소 권한 원칙 (Least Privilege)**
  - IAM Role 최소 권한
  - Security Group 최소 개방

  **3. 마이크로 세그멘테이션 (Micro-segmentation)**
  - Service Mesh로 Pod 간 격리
  - Namespace 기반 네트워크 정책

  **4. 지속적 모니터링 (Continuous Monitoring)**
  - 모든 트래픽 로그
  - 이상 행동 실시간 탐지

  **5. 다중 인증 (Multi-Factor Authentication)**
  - Bastion 접근: MFA 필수
  - AWS Console: MFA 강제
end note

' ───────────────────────────────────────────────────────────
' 컴플라이언스
' ───────────────────────────────────────────────────────────
note as compliance
  **컴플라이언스 준수**

  **GDPR (유럽)**:
  - 개인정보 암호화 저장
  - 데이터 삭제 요청 처리
  - EU Region 데이터 격리

  **PCI-DSS (결제 정보)**:
  - 결제 데이터 토큰화
  - 카드번호 평문 저장 금지
  - 분기별 취약점 스캔

  **SOC 2 Type II**:
  - 접근 로그 1년 보관
  - 정기 보안 감사
  - 사고 대응 절차 문서화

  **ISO 27001**:
  - 정보 보안 정책
  - 리스크 평가
  - ISMS 인증
end note

@enduml
