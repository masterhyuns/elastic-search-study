@startuml C4_Level3_컴포넌트_다이어그램
' ============================================================
' 템플릿: C4 Model Level 3 - Component Diagram
' 사용 사례:
'   - 서비스 내부 구조 (User Service 예시)
'   - Layered Architecture (Controller-Service-Repository)
'   - 컴포넌트 간 의존성
' ============================================================

!theme plain
skinparam backgroundColor white

title C4 Model - Level 3: Component Diagram (User Service)

' ───────────────────────────────────────────────────────────
' 스타일 정의
' ───────────────────────────────────────────────────────────
skinparam component {
  BackgroundColor<<controller>> #F0F0F0
  BackgroundColor<<service>> #E0E0E0
  BackgroundColor<<repository>> #D0D0D0
  BackgroundColor<<middleware>> #C8C8C8
  BorderColor Black
}

skinparam database {
  BackgroundColor #C0C0C0
  BorderColor Black
}

skinparam queue {
  BackgroundColor #B8B8B8
  BorderColor Black
}

' ───────────────────────────────────────────────────────────
' 외부에서 들어오는 요청
' ───────────────────────────────────────────────────────────
[API Gateway] as gateway

' ───────────────────────────────────────────────────────────
' User Service 내부 컴포넌트
' ───────────────────────────────────────────────────────────
package "User Service" {
  [Auth Middleware] <<middleware>> as authMiddleware
  [Validation Middleware] <<middleware>> as validationMiddleware

  [User Controller] <<controller>> as userController
  [Auth Controller] <<controller>> as authController

  [User Service] <<service>> as userService
  [Auth Service] <<service>> as authService
  [Email Service] <<service>> as emailService

  [User Repository] <<repository>> as userRepo
  [Session Repository] <<repository>> as sessionRepo
}

' ───────────────────────────────────────────────────────────
' 외부 의존성
' ───────────────────────────────────────────────────────────
database "PostgreSQL" as db
database "Redis" as cache
queue "Kafka" as kafka

' ───────────────────────────────────────────────────────────
' 요청 흐름
' ───────────────────────────────────────────────────────────
gateway --> authMiddleware : HTTP Request
authMiddleware --> validationMiddleware
validationMiddleware --> userController
validationMiddleware --> authController

userController --> userService
authController --> authService

userService --> userRepo
authService --> userRepo
authService --> sessionRepo
userService --> emailService

userRepo --> db
sessionRepo --> cache
userService ..> kafka : Publish Events
emailService ..> kafka : Publish Events

' ───────────────────────────────────────────────────────────
' 주석
' ───────────────────────────────────────────────────────────
note right of authMiddleware
  **Middleware 체인**

  1. Auth Middleware
     - JWT 검증
     - 사용자 정보 추출

  2. Validation Middleware
     - Request Body 검증 (Zod)
     - 타입 체크

  3. Error Middleware
     - 예외 처리
     - 표준화된 에러 응답
end note

note bottom of userService
  **Service Layer (비즈니스 로직)**

  ```typescript
  class UserService {
    async registerUser(dto: RegisterUserDto) {
      // 1. 이메일 중복 검사
      // 2. 비밀번호 해싱
      // 3. User Entity 생성
      // 4. 저장
      // 5. UserRegistered 이벤트 발행
      // 6. 환영 이메일 발송 트리거
    }
  }
  ```

  **원칙**:
  - Controller는 얇게 (Thin)
  - Service에 로직 집중
  - Repository는 데이터 접근만
end note

note bottom of userRepo
  **Repository Pattern**

  **책임**:
  - DB 추상화 (ORM 캡슐화)
  - 컬렉션처럼 사용

  ```typescript
  interface IUserRepository {
    findById(id: string): Promise<User | null>
    findByEmail(email: string): Promise<User | null>
    save(user: User): Promise<void>
    delete(id: string): Promise<void>
  }
  ```

  **장점**:
  - 테스트 용이 (Mock 가능)
  - DB 교체 시 Repository만 수정
end note

legend right
  **C4 Model Level 3**

  **목적**: 서비스 내부 구조
  **대상**: 개발자

  **Layered Architecture**:
  1. Middleware (인증, 검증)
  2. Controller (라우팅, DTO 변환)
  3. Service (비즈니스 로직)
  4. Repository (데이터 접근)

  **다음 레벨**:
  Level 4 (Code) → 클래스 다이어그램
end legend

@enduml
