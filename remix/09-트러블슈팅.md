# Remix 트러블슈팅 가이드 🔧

Remix 개발 중 자주 발생하는 문제와 해결 방법을 모았습니다.

---

## 목차
1. [일반적인 문제](#일반적인-문제)
2. [라우팅 문제](#라우팅-문제)
3. [데이터 로딩 문제](#데이터-로딩-문제)
4. [Form 문제](#form-문제)
5. [세션 및 쿠키 문제](#세션-및-쿠키-문제)
6. [빌드 및 배포 문제](#빌드-및-배포-문제)
7. [성능 문제](#성능-문제)
8. [타입스크립트 문제](#타입스크립트-문제)

---

## 일반적인 문제

### 문제: "window is not defined" 에러

**원인**: 서버에서 브라우저 API 사용

```typescript
// ❌ 잘못된 예
export const loader = async () => {
  const width = window.innerWidth; // 서버에는 window가 없음
  return json({ width });
};
```

**해결책**: 클라이언트에서만 실행되도록 수정

```typescript
// ✅ 올바른 예
export default function MyComponent() {
  const [width, setWidth] = useState(0);

  useEffect(() => {
    setWidth(window.innerWidth);
  }, []);

  return <div>{width}</div>;
}
```

---

### 문제: "Cannot read property 'get' of undefined" (FormData)

**원인**: FormData를 중복으로 읽음

```typescript
// ❌ 잘못된 예
export const action = async ({ request }: ActionFunctionArgs) => {
  const formData = await request.formData();
  const title = formData.get("title");

  // 두 번째 formData() 호출 - 에러!
  const data = await request.formData();
};
```

**해결책**: FormData를 한 번만 읽고 재사용

```typescript
// ✅ 올바른 예
export const action = async ({ request }: ActionFunctionArgs) => {
  const formData = await request.formData();
  const title = formData.get("title");
  const content = formData.get("content");

  // 같은 formData 재사용
  console.log(title, content);
};
```

---

### 문제: 환경 변수가 undefined

**원인**: 클라이언트에서 서버 전용 환경 변수 접근

```typescript
// ❌ 클라이언트에서 접근 불가
export default function Component() {
  const apiKey = process.env.DATABASE_URL; // undefined
}
```

**해결책 1**: loader에서 전달

```typescript
// ✅ 서버(loader)에서 전달
export const loader = async () => {
  return json({
    publicApiKey: process.env.PUBLIC_API_KEY
  });
};

export default function Component() {
  const { publicApiKey } = useLoaderData<typeof loader>();
}
```

**해결책 2**: PUBLIC_ 접두사 사용 (Vite)

```bash
# .env
PUBLIC_API_KEY=abc123
```

```typescript
const apiKey = import.meta.env.PUBLIC_API_KEY;
```

---

## 라우팅 문제

### 문제: 404 페이지가 표시되지 않음

**원인**: Catch-all 라우트 누락

**해결책**: `$.tsx` 라우트 생성

```typescript
// app/routes/$.tsx
export default function NotFound() {
  return (
    <div>
      <h1>404 - 페이지를 찾을 수 없습니다</h1>
      <Link to="/">홈으로 가기</Link>
    </div>
  );
}
```

---

### 문제: 중첩 라우트에서 Outlet이 렌더링되지 않음

**원인**: Outlet 컴포넌트 누락

```typescript
// ❌ Outlet 없음
export default function Dashboard() {
  return <div>대시보드</div>;
}
```

**해결책**: Outlet 추가

```typescript
// ✅ Outlet 추가
import { Outlet } from "@remix-run/react";

export default function Dashboard() {
  return (
    <div>
      <nav>사이드바</nav>
      <main>
        <Outlet /> {/* 자식 라우트가 여기 렌더링 */}
      </main>
    </div>
  );
}
```

---

### 문제: 동적 라우트 파라미터가 undefined

**원인**: 파일명과 params 키 불일치

```typescript
// app/routes/posts.$id.tsx
export const loader = async ({ params }: LoaderFunctionArgs) => {
  const postId = params.postId; // undefined! (올바른 키는 'id')
};
```

**해결책**: 파일명의 `$` 뒤 이름과 일치시키기

```typescript
// ✅ 올바른 예
export const loader = async ({ params }: LoaderFunctionArgs) => {
  const id = params.id; // ✅
};
```

---

## 데이터 로딩 문제

### 문제: loader 데이터가 업데이트되지 않음

**원인**: 브라우저 캐시

**해결책 1**: 캐시 헤더 수정

```typescript
export const headers = () => ({
  "Cache-Control": "no-cache"
});
```

**해결책 2**: 수동 재검증

```typescript
import { useRevalidator } from "@remix-run/react";

const revalidator = useRevalidator();

const handleRefresh = () => {
  revalidator.revalidate();
};
```

---

### 문제: "useLoaderData must be used within a data router"

**원인**: 라우트 컴포넌트가 아닌 곳에서 사용

```typescript
// ❌ 일반 컴포넌트에서 사용
// components/Header.tsx
export default function Header() {
  const data = useLoaderData(); // 에러!
}
```

**해결책 1**: useRouteLoaderData 사용

```typescript
// ✅ 부모 라우트의 데이터 접근
import { useRouteLoaderData } from "@remix-run/react";

export default function Header() {
  const data = useRouteLoaderData("routes/_index");
}
```

**해결책 2**: props로 전달

```typescript
// ✅ Props로 전달
export default function MyRoute() {
  const data = useLoaderData<typeof loader>();
  return <Header data={data} />;
}
```

---

### 문제: loader에서 비동기 데이터가 로드되지 않음

**원인**: await 누락

```typescript
// ❌ await 없음
export const loader = async () => {
  const data = fetchData(); // Promise 반환
  return json({ data }); // Promise가 그대로 전달됨
};
```

**해결책**: await 추가

```typescript
// ✅ await 추가
export const loader = async () => {
  const data = await fetchData();
  return json({ data });
};
```

---

## Form 문제

### 문제: Form 제출 후 페이지 새로고침됨

**원인**: HTML form 사용 (Remix Form 아님)

```typescript
// ❌ 소문자 form
<form method="post">
  <button type="submit">제출</button>
</form>
```

**해결책**: Remix Form 사용

```typescript
// ✅ 대문자 Form
import { Form } from "@remix-run/react";

<Form method="post">
  <button type="submit">제출</button>
</Form>
```

---

### 문제: action에서 formData가 비어있음

**원인 1**: encType 누락 (파일 업로드 시)

```typescript
// ❌ encType 없음
<Form method="post">
  <input type="file" name="file" />
</Form>
```

**해결책**: encType 추가

```typescript
// ✅ encType 추가
<Form method="post" encType="multipart/form-data">
  <input type="file" name="file" />
</Form>
```

**원인 2**: name 속성 누락

```typescript
// ❌ name 없음
<Form method="post">
  <input type="text" /> {/* name이 없음 */}
</Form>
```

**해결책**: name 추가

```typescript
// ✅ name 추가
<Form method="post">
  <input name="title" type="text" />
</Form>
```

---

### 문제: useFetcher의 data가 undefined

**원인**: action이 아무것도 반환하지 않음

```typescript
// ❌ 반환 없음
export const action = async ({ request }: ActionFunctionArgs) => {
  await saveData();
  // return 없음
};
```

**해결책**: 데이터 반환

```typescript
// ✅ 데이터 반환
export const action = async ({ request }: ActionFunctionArgs) => {
  await saveData();
  return json({ success: true });
};
```

---

## 세션 및 쿠키 문제

### 문제: 세션이 저장되지 않음

**원인**: commitSession 누락

```typescript
// ❌ commitSession 없음
export const loader = async ({ request }: LoaderFunctionArgs) => {
  const session = await getSession(request.headers.get("Cookie"));
  session.set("key", "value");
  return json({}); // 세션이 저장되지 않음
};
```

**해결책**: Set-Cookie 헤더 추가

```typescript
// ✅ commitSession 추가
export const loader = async ({ request }: LoaderFunctionArgs) => {
  const session = await getSession(request.headers.get("Cookie"));
  session.set("key", "value");

  return json(
    {},
    {
      headers: {
        "Set-Cookie": await commitSession(session)
      }
    }
  );
};
```

---

### 문제: 쿠키가 브라우저에 저장되지 않음

**원인**: SameSite/Secure 설정 문제

**해결책**: 환경에 맞게 설정

```typescript
const sessionStorage = createCookieSessionStorage({
  cookie: {
    name: "session",
    secure: process.env.NODE_ENV === "production", // HTTPS에서만
    sameSite: "lax", // "strict" 대신 "lax" 사용
    path: "/",
    httpOnly: true
  }
});
```

---

## 빌드 및 배포 문제

### 문제: 빌드 시 "Module not found" 에러

**원인**: 서버/클라이언트 전용 코드 혼용

**해결책**: `.server.ts` / `.client.ts` 파일명 사용

```typescript
// utils/db.server.ts (서버 전용)
export const db = new PrismaClient();

// utils/analytics.client.ts (클라이언트 전용)
export const trackEvent = (name: string) => {
  if (typeof window !== "undefined") {
    window.gtag("event", name);
  }
};
```

---

### 문제: 배포 후 환경 변수가 작동하지 않음

**원인**: 환경 변수 미설정

**해결책**: 배포 플랫폼에서 환경 변수 설정

```bash
# Vercel
vercel env add SESSION_SECRET

# Fly.io
fly secrets set SESSION_SECRET=abc123

# Railway
railway variables set SESSION_SECRET=abc123
```

---

### 문제: CSS가 적용되지 않음

**원인**: links 함수 누락

**해결책**: links 함수 추가

```typescript
// ❌ links 없음
import styles from "./styles.css";

export default function Component() {
  return <div>Hello</div>;
}
```

```typescript
// ✅ links 추가
import { LinksFunction } from "@remix-run/node";
import styles from "./styles.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: styles }
];

export default function Component() {
  return <div>Hello</div>;
}
```

---

## 성능 문제

### 문제: 페이지 로딩이 느림

**원인 1**: 순차적 데이터 로딩

```typescript
// ❌ 순차 실행 (3초)
export const loader = async () => {
  const user = await getUser(); // 1초
  const posts = await getPosts(); // 1초
  const comments = await getComments(); // 1초
  return json({ user, posts, comments });
};
```

**해결책**: 병렬 로딩

```typescript
// ✅ 병렬 실행 (1초)
export const loader = async () => {
  const [user, posts, comments] = await Promise.all([
    getUser(),
    getPosts(),
    getComments()
  ]);
  return json({ user, posts, comments });
};
```

**원인 2**: 불필요한 데이터 로딩

**해결책**: defer 사용

```typescript
import { defer } from "@remix-run/node";

export const loader = async () => {
  return defer({
    critical: await getCriticalData(), // 즉시
    optional: getOptionalData() // 나중에
  });
};
```

---

### 문제: 번들 크기가 너무 큼

**원인**: 큰 라이브러리 전체 import

```typescript
// ❌ 전체 라이브러리
import _ from "lodash"; // 70KB
```

**해결책**: 필요한 함수만 import

```typescript
// ✅ 필요한 것만
import debounce from "lodash/debounce"; // 5KB
```

---

## 타입스크립트 문제

### 문제: useLoaderData 타입 추론 안 됨

**원인**: 타입 지정 누락

```typescript
// ❌ 타입 없음
const data = useLoaderData();
```

**해결책**: typeof loader 사용

```typescript
// ✅ 타입 지정
const data = useLoaderData<typeof loader>();
```

---

### 문제: FormData 타입 에러

**원인**: FormData 값이 null일 수 있음

```typescript
// ❌ 타입 에러
const title: string = formData.get("title"); // string | null
```

**해결책**: null 체크 또는 타입 단언

```typescript
// ✅ null 체크
const title = formData.get("title");
if (!title) {
  return json({ error: "Title required" }, { status: 400 });
}

// ✅ 타입 단언
const title = formData.get("title")!.toString();
```

---

## 디버깅 팁

### 1. 서버 로그 확인

```typescript
export const loader = async ({ request, params }: LoaderFunctionArgs) => {
  console.log("Loader called:", {
    url: request.url,
    params,
    method: request.method
  });

  const data = await fetchData();
  console.log("Data loaded:", data);

  return json({ data });
};
```

### 2. Network 탭 활용

브라우저 개발자 도구 → Network 탭에서:
- loader/action 요청 확인
- 응답 데이터 확인
- 헤더 확인 (Cache-Control, Set-Cookie 등)

### 3. Remix DevTools

```bash
pnpm add -D remix-development-tools
```

```typescript
// app/root.tsx
import { RemixDevTools } from "remix-development-tools";

export default function App() {
  return (
    <>
      <Outlet />
      <RemixDevTools />
    </>
  );
}
```

### 4. React DevTools Profiler

성능 문제 디버깅:
- React DevTools 설치
- Profiler 탭에서 렌더링 시간 측정
- 불필요한 리렌더링 확인

---

## 자주 묻는 질문

### Q: loader에서 redirect하면 컴포넌트가 렌더링되나요?

**A**: 아니요. redirect는 throw하므로 컴포넌트는 렌더링되지 않습니다.

```typescript
export const loader = async () => {
  return redirect("/login"); // 여기서 중단
};

export default function Component() {
  // 실행되지 않음
  return <div>Hello</div>;
}
```

---

### Q: action에서 데이터를 어떻게 검증하나요?

**A**: Zod 같은 스키마 검증 라이브러리 사용을 권장합니다.

```typescript
import { z } from "zod";

const Schema = z.object({
  email: z.string().email(),
  password: z.string().min(8)
});

export const action = async ({ request }: ActionFunctionArgs) => {
  const formData = await request.formData();

  const result = Schema.safeParse({
    email: formData.get("email"),
    password: formData.get("password")
  });

  if (!result.success) {
    return json({ errors: result.error.flatten() }, { status: 400 });
  }

  // 검증된 데이터 사용
  const { email, password } = result.data;
};
```

---

### Q: 파일 업로드 크기 제한은?

**A**: 서버 설정에 따라 다릅니다. 기본값은 보통 ~1MB입니다.

```typescript
// remix.config.js
module.exports = {
  serverModuleFormat: "esm",
  // 크기 제한 없음 (주의: 보안 위험)
  serverDependenciesToBundle: [/.*/],
};
```

**권장**: action에서 크기 검증

```typescript
export const action = async ({ request }: ActionFunctionArgs) => {
  const formData = await request.formData();
  const file = formData.get("file") as File;

  const maxSize = 5 * 1024 * 1024; // 5MB
  if (file.size > maxSize) {
    return json({ error: "파일 크기는 5MB 이하여야 합니다" }, { status: 400 });
  }

  // 업로드 처리
};
```

---

## 도움 받기

### 공식 리소스
- [Remix 공식 문서](https://remix.run/docs)
- [Remix GitHub Issues](https://github.com/remix-run/remix/issues)
- [Remix Discord](https://rmx.as/discord)

### 커뮤니티
- [Stack Overflow](https://stackoverflow.com/questions/tagged/remix)
- [Reddit r/remix](https://www.reddit.com/r/remix)

### 질문하기 전 체크리스트
- [ ] 에러 메시지 전체 확인
- [ ] 콘솔/서버 로그 확인
- [ ] 공식 문서 검색
- [ ] GitHub Issues 검색
- [ ] 최소 재현 예제 준비

---

**문제가 해결되지 않으면 커뮤니티에 질문하세요! 🙋**
